name: Deploy SwanyThree Ultimate

on:
    push:
        branches: [main]
        paths-ignore:
            - "README.md"
            - "docs/**"

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: "20"

            - name: Install dependencies
              run: |
                  cd services/api
                  npm ci

            - name: Run linting
              run: |
                  cd services/api
                  npm run lint || true

            - name: Run tests
              run: |
                  cd services/api
                  npm test -- --coverage || true

            - name: Upload coverage
              uses: codecov/codecov-action@v3

    build:
        needs: test
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Login to DockerHub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and push images
              run: |
                  docker-compose -f docker-compose.prod.yml build
                  docker-compose -f docker-compose.prod.yml push

    deploy:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3

            - name: Deploy to production
              run: |
                  ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
                    cd /opt/swanythree-ultimate
                    git pull origin main
                    docker-compose -f docker-compose.prod.yml pull
                    docker-compose -f docker-compose.prod.yml up -d
                    docker system prune -af
                  EOF

            - name: Health check
              run: |
                  sleep 30
                  curl -f https://api.swanythree.com/health || exit 1

            - name: Notify Discord
              uses: sarisia/actions-status-discord@v1
              with:
                  webhook: ${{ secrets.DISCORD_WEBHOOK }}
                  status: ${{ job.status }}
